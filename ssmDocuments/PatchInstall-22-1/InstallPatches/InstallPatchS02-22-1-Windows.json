{
  "schemaVersion": "2.2",
  "description": "RunCommandInstallPatchS02-22-1-Windows",
  "parameters": {
  },
  "mainSteps": [
    {
      "action": "aws:runPowerShellScript",
      "name": "lookForPatchS02",
      "inputs": {
        "timeoutSeconds": 300 ,
        "runCommand": ["while (!(Test-Path -Path 'C:\\Program Files\\Precisely\\ExtractedPatches\\cdq20221s02.zip')) {Start-Sleep 10}"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "stopServer",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Stop-Service -Name 'spectrum-server' -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "listenForServerStop",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["while($true){ Get-Content 'C:\\Program Files\\Precisely\\Spectrum\\server\\logs\\spectrum-server.log' -Tail 10 -Wait | Select-String 'Precisely Spectrum Technology Platform shutdown complete' | %{write-host Found $_; break}}"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "createPatchS02Backup",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["New-Item -Path 'C:\\Program Files\\Precisely\\PatchesBackups' -Name 'PatchS02' -ItemType 'directory' "]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "backupCLI",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\server\\exports' -Destination 'C:\\Program Files\\Precisely\\PatchesBackups\\PatchS02' -Recurse "]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "expandCLIZip",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Expand-Archive -LiteralPath 'C:\\Program Files\\Precisely\\spectrum\\server\\exports\\spectrum-cli-22.1.zip' -DestinationPath 'C:\\Program Files\\Precisely\\spectrum\\server\\exports\\spectrum-cli-22.1' -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteG1Assemblies",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["if (Test-Path -Path 'C:\\Users\\Administrator\\AppData\\Local\\Temp\\2\\g1Assemblies') {Remove-Item 'C:\\Users\\Administrator\\AppData\\Local\\Temp\\2\\g1Assemblies' -Recurse -Force -Confirm:$false} else {break}"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "expandPatchCLIZip",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Expand-Archive -LiteralPath 'C:\\Program Files\\Precisely\\Patches\\cdq20221s02\\server\\exports\\spectrum-cli-22.1.zip' -DestinationPath 'C:\\Program Files\\Precisely\\Patches\\cdq20221s02\\server\\exports\\spectrum-cli-22.1' -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "extractPatchS02",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Expand-Archive -LiteralPath 'C:\\Program Files\\Precisely\\ExtractedPatches\\cdq20221s02.zip' -DestinationPath 'C:\\Program Files\\Precisely\\Spectrum' -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "zipCLIZip",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Compress-Archive -Path 'C:\\Program Files\\Precisely\\spectrum\\server\\exports\\spectrum-cli-22.1' -DestinationPath 'C:\\Program Files\\Precisely\\spectrum\\server\\exports\\spectrum-cli-22.1.zip' -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "startServer",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Start-Service -Name 'spectrum-server'"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "startSleepServer",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Start-Sleep -Seconds 15"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "listenForServerStart",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["while($true){ Get-Content 'C:\\Program Files\\Precisely\\Spectrum\\server\\logs\\spectrum-server.log' -Tail 1 -Wait | Select-String -Pattern 'Precisely Spectrum Technology Platform' | %{write-host Found $_; break}}"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteExpandedArchive",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item 'C:\\Program Files\\Precisely\\Spectrum\\server\\exports\\spectrum-cli-22.1' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deletePatchesFolder",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item 'C:\\Program Files\\Precisely\\Patches' -Recurse -Force -Confirm:$false"]
      }
    }
  ]
}