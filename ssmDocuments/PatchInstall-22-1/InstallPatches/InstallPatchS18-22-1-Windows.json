{
  "schemaVersion": "2.2",
  "description": "RunCommandInstallPatchS18-22-1-Windows",
  "parameters": {},
  "mainSteps": [
    {
      "action": "aws:runPowerShellScript",
      "name": "lookForPatchS18",
      "inputs": {
        "timeoutSeconds": 300 ,
        "runCommand": ["while (!(Test-Path -Path 'C:\\Program Files\\Precisely\\ExtractedPatches\\cdq20221s18.zip')) {Start-Sleep 10}"]
      }
    },
    {
      "action": "aws:downloadContent",
      "name": "downloadV10Data",
      "inputs": {
        "sourceType": "S3",
        "sourceInfo": {
          "path": "https://cloudformation-spectrum.s3.amazonaws.com/Modules/GAV/S18PatchDataUS/"
        },
        "destinationPath": "C:\\Program Files\\Precisely\\GAV\\S18PatchDataUS"
      }
    },
    {
      "action": "aws:downloadContent",
      "name": "downloadV10Scripts",
      "inputs": {
        "sourceType": "S3",
        "sourceInfo": {
          "path": "https://cloudformation-spectrum.s3.amazonaws.com/Modules/GAV/GAV-Windows/moduleScriptsUSWindowsPatchS18/"
        },
        "destinationPath": "C:\\Program Files\\Precisely\\GAV\\moduleScriptsUSWindowsPatchS18"
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteV3GAVUS",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["cd 'C:/Program Files/Precisely/spectrum-cli-22.1'",
        "./cli.cmd --cmdfile 'C:/Program Files/Precisely/GAV/moduleScriptsUSWindowsPatchS18/GAVUSv3ResourceDelete.cli'"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "moveV10Data",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Move-Item -Path 'C:\\Program Files\\Precisely\\GAV\\S18PatchDataUS\\*.spd' -Destination 'C:\\Program Files\\Precisely\\Spectrum\\server\\import'"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "listenForV10DataUploadGAVUSDOM",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["while($true){ Get-Content 'C:\\Program Files\\Precisely\\Spectrum\\server\\logs\\spectrum-server.log' -Wait | Select-String 'Registered GAV_US_DOM_052023.spd' | %{write-host Found $_; break}}"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "listenForV10DataUploadGAVUSNONDOM",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["while($true){ Get-Content 'C:\\Program Files\\Precisely\\Spectrum\\server\\logs\\spectrum-server.log' -Wait | Select-String 'Registered GAV_US_NON_DOM_052023.spd' | %{write-host Found $_; break}}"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "stopServer",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Stop-Service -Name 'spectrum-server' -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "listenForServerStop",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["while($true){ Get-Content 'C:\\Program Files\\Precisely\\Spectrum\\server\\logs\\spectrum-server.log' -Tail 1 -Wait | Select-String 'Precisely Spectrum Technology Platform shutdown complete' | %{write-host Found $_; break}}"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "createPatchS18Backup",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["New-Item -Path 'C:\\Program Files\\Precisely\\PatchesBackups' -Name 'PatchS18' -ItemType 'directory' "]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "backupServerDeploy",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\server\\deploy' -Destination 'C:\\Program Files\\Precisely\\PatchesBackups\\PatchS18\\server\\deploy' -Recurse "]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "backupServerModules",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\server\\modules' -Destination 'C:\\Program Files\\Precisely\\PatchesBackups\\PatchS18\\server\\modules' -Recurse "]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteGAVUS",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\server\\modules\\GlobalAddressValidationUS' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteGAV",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\server\\modules\\GlobalAddressValidation' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "extractPatchS18",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Expand-Archive -LiteralPath 'C:\\Program Files\\Precisely\\ExtractedPatches\\cdq20221s18.zip' -DestinationPath 'C:\\Program Files\\Precisely\\Spectrum' -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "startServer",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Start-Service -Name 'spectrum-server'"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "startSleepServer",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Start-Sleep -Seconds 15"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "listenForServerStart",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["while($true){ Get-Content 'C:\\Program Files\\Precisely\\Spectrum\\server\\logs\\spectrum-server.log' -Tail 1 -Wait | Select-String -Pattern 'Precisely Spectrum Technology Platform' | %{write-host Found $_; break}}"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "createV10GAVUS",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["cd 'C:/Program Files/Precisely/spectrum-cli-22.1'",
        "./cli.cmd --cmdfile 'C:/Program Files/Precisely/GAV/moduleScriptsUSWindowsPatchS18/GAVUSv10ResourceCreate.cli'"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteGAVFolder",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item 'C:\\Program Files\\Precisely\\GAV' -Recurse -Force -Confirm:$false"]
      }
    }
  ]
}