{
  "schemaVersion": "2.2",
  "description": "RunCommandInstallPatchS12-22-1-Windows",
  "parameters": {},
  "mainSteps": [
    {
      "action": "aws:runPowerShellScript",
      "name": "lookForPatchS12",
      "inputs": {
        "timeoutSeconds": 300 ,
        "runCommand": ["while (!(Test-Path -Path 'C:\\Program Files\\Precisely\\Patches\\cdq20221s12')) {Start-Sleep 10}"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "stopServer",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Stop-Service -Name 'spectrum-server' -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "listenForServerStop",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["while($true){ Get-Content 'C:\\Program Files\\Precisely\\Spectrum\\server\\logs\\spectrum-server.log' -Tail 1 -Wait | Select-String 'Precisely Spectrum Technology Platform shutdown complete' | %{write-host Found $_; break}}"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "createPatchS12Backup",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["New-Item -Path 'C:\\Program Files\\Precisely\\PatchesBackups' -Name 'PatchS12' -ItemType 'directory' "]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "backupIndexLib",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\lib' -Destination 'C:\\Program Files\\Precisely\\PatchesBackups\\PatchS12\\index\\lib' -Recurse "]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "backupIndexPlugOpenSec",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro_security' -Destination 'C:\\Program Files\\Precisely\\PatchesBackups\\PatchS12\\index\\plugins\\opendistro_security' -Recurse "]
      }
    },{
      "action": "aws:runPowerShellScript",
      "name": "backupIndexPlugOpenSql",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro-sql' -Destination 'C:\\Program Files\\Precisely\\PatchesBackups\\PatchS12\\index\\plugins\\opendistro-sql' -Recurse "]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "backupRepository",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\repository' -Destination 'C:\\Program Files\\Precisely\\PatchesBackups\\PatchS12\\repository' -Recurse "]
      }
    },{
      "action": "aws:runPowerShellScript",
      "name": "backupServerDeploy",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\server\\deploy' -Destination 'C:\\Program Files\\Precisely\\PatchesBackups\\PatchS12\\server\\deploy' -Recurse "]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "backupServerLib",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\server\\lib' -Destination 'C:\\Program Files\\Precisely\\PatchesBackups\\PatchS12\\server\\lib' -Recurse "]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteRepository",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\repository' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteServerLib",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\server\\lib' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteIndexLibSnake",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\lib\\snakeyaml-1.26.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteIndexLibJackson",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\lib\\jackson-core-2.13.3.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteIndexPlugOpenSecJacksonData",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro_security\\jackson-databind-2.13.3.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteIndexPlugOpenSecJacksonAnno",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro_security\\jackson-annotations-2.13.3.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteIndexPlugOpenSqlJacksonData",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro-sql\\jackson-databind-2.13.3.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteIndexPlugOpenSqlJacksonAnno",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro-sql\\jackson-annotations-2.11.4.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteIndexPlugOpenSqlSpringJCL",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro-sql\\spring-jcl-5.2.19.RELEASE.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deletedeleteIndexPlugOpenSqlSpringExp",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro-sql\\spring-expression-5.2.21.RELEASE.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteIndexPlugOpenSqlSpringCore",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro-sql\\spring-core-5.2.19.RELEASE.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deletedeleteIndexPlugOpenSqlSpringContext",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro-sql\\spring-context-5.2.21.RELEASE.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deleteIndexPlugOpenSqlSpringBeans",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro-sql\\spring-beans-5.2.21.RELEASE.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "deletedeleteIndexPlugOpenSqlSpringAop",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Remove-Item -Path 'C:\\Program Files\\Precisely\\Spectrum\\index\\plugins\\opendistro-sql\\spring-aop-5.2.19.RELEASE.jar' -Recurse -Force -Confirm:$false"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "replaceIndex",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Patches\\cdq20221s12\\index' -Destination 'C:\\Program Files\\Precisely\\Spectrum' -Recurse -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "replaceRepository",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Patches\\cdq20221s12\\repository' -Destination 'C:\\Program Files\\Precisely\\Spectrum' -Recurse -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "replaceServer",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\Patches\\cdq20221s12\\server' -Destination 'C:\\Program Files\\Precisely\\Spectrum' -Recurse -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "replaceRepoData",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Copy-Item -Path 'C:\\Program Files\\Precisely\\PatchesBackups\\PatchS12\\repository\\data' -Destination 'C:\\Program Files\\Precisely\\Spectrum\\repository' -Recurse -Force"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "startServer",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["Start-Service -Name 'spectrum-server'"]
      }
    },
    {
      "action": "aws:runPowerShellScript",
      "name": "listenForServerStart",
      "inputs": {
        "timeoutSeconds": 10800 ,
        "runCommand": ["while($true){ Get-Content 'C:\\Program Files\\Precisely\\Spectrum\\server\\logs\\spectrum-server.log' -Tail 1 -Wait | Select-String -Pattern 'Precisely Spectrum Technology Platform' | %{write-host Found $_; break}}"]
      }
    }
  ]
}